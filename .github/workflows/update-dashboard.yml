name: Update Code Health Dashboard

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM UTC
  workflow_dispatch:      # Allow manual trigger
  push:
    branches: [ main ]    # Also run on push to test

jobs:
  update-metrics:
    runs-on: ubuntu-latest
    permissions:
      contents: write     # Need write permission to commit

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git log

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install radon pylint pytest pytest-cov || true

      - name: Verify scripts exist
        run: |
          echo "Checking for required scripts..."
          ls -la scripts/
          test -f scripts/analyze_metrics.py && echo " analyze_metrics.py found" || echo " analyze_metrics.py missing"
          test -f scripts/update_dashboard.py && echo " update_dashboard.py found" || echo " update_dashboard.py missing"
          test -f index.html && echo " index.html found" || echo " index.html missing"

      - name: Analyze code metrics
        run: |
          echo "Running metrics analysis..."
          python scripts/analyze_metrics.py || echo "Analysis failed, will use defaults"

      - name: Update dashboard HTML
        run: |
          echo "Updating dashboard..."
          python scripts/update_dashboard.py || echo "Dashboard update encountered issues"

      - name: Check for changes
        id: check_changes
        run: |
          git diff --exit-code index.html metrics.json || echo "changes=true" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions Bot"
          git add index.html metrics.json || true
          git commit -m " Auto-update dashboard metrics - $(date +'%Y-%m-%d')" || true
          git push || true

      - name: Summary
        run: |
          echo " Workflow completed!"
          echo " Dashboard: https://ishwarya813.github.io/code-health-dashboard/"
