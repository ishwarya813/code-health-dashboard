name: Update Code Health Dashboard

on:
  # Run every Monday at 9 AM UTC
  schedule:
    - cron: '0 9 * * 1'
  
  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:
  
  # Run on push to main branch (for testing)
  push:
    branches: [ main ]

jobs:
  update-metrics:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install radon pytest-cov beautifulsoup4 lxml
    
    - name: Analyze codebase complexity
      id: analyze
      run: |
        # Run complexity analysis on Python files
        echo "Running complexity analysis..."
        
        # Get cyclomatic complexity metrics
        if [ -d "python" ]; then
          radon cc python/ -a -s > complexity_report.txt
          COMPLEXITY=$(radon cc python/ -a -s | grep "Average complexity" | awk '{print $NF}' | sed 's/[()]//g')
          echo "Current complexity: $COMPLEXITY"
          echo "complexity=$COMPLEXITY" >> $GITHUB_OUTPUT
        else
          echo "complexity=30" >> $GITHUB_OUTPUT
        fi
        
        # Get test coverage (if tests exist)
        if [ -d "tests" ]; then
          pytest --cov=python --cov-report=json tests/ || true
          if [ -f "coverage.json" ]; then
            COVERAGE=$(python -c "import json; data=json.load(open('coverage.json')); print(int(data['totals']['percent_covered']))")
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          else
            echo "coverage=0" >> $GITHUB_OUTPUT
          fi
        else
          echo "coverage=0" >> $GITHUB_OUTPUT
        fi
        
        # Get code churn (commits in last 30 days per file)
        echo "Analyzing code churn..."
        git log --since="30 days ago" --pretty=format: --name-only | sort | uniq -c | sort -rn | head -5 > churn_report.txt
        cat churn_report.txt
    
    - name: Update dashboard HTML
      run: |
        python scripts/update_dashboard.py
    
    - name: Commit and push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Add changes
        git add code_health_dashboard.html
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ðŸ“Š Auto-update dashboard metrics - $(date +'%Y-%m-%d')"
          git push
          echo "Dashboard updated successfully!"
        fi
    
    - name: Upload reports as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: analysis-reports
        path: |
          complexity_report.txt
          churn_report.txt
          coverage.json
        retention-days: 30
